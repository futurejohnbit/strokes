<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro:bit è—ç‰™è®€å¯«æ¸¬è©¦ (äº¤äº’è¨ºæ–·)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background: #f5f7fa; color: #333; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e1e4e8; }
        .full-width { grid-column: span 2; }
        h1 { color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        h2 { font-size: 1.2rem; color: #34495e; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        
        button { padding: 10px 20px; font-size: 15px; cursor: pointer; color: white; border: none; border-radius: 6px; transition: all 0.2s; font-weight: 600; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #cbd5e0 !important; cursor: not-allowed; transform: none; }
        .btn-connect { background: #3182ce; width: 100%; padding: 15px; font-size: 1.1rem; }
        .btn-send { background: #38a169; }
        .btn-cmd { background: #4a5568; margin-right: 5px; margin-bottom: 5px; font-size: 0.9rem; padding: 8px 12px; }
        
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }
        .status-disconnected { background: #fed7d7; color: #c53030; }
        .status-connected { background: #c6f6d5; color: #2f855a; }
        
        #log { height: 300px; overflow-y: auto; background: #1a202c; color: #a0aec0; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.9rem; line-height: 1.5; }
        .log-time { color: #718096; margin-right: 10px; user-select: none; }
        .log-tx { color: #68d391; } /* ç¶ è‰²ï¼šç™¼é€ */
        .log-rx { color: #63b3ed; } /* è—è‰²ï¼šæ¥æ”¶ */
        .log-sys { color: #f6e05e; } /* é»ƒè‰²ï¼šç³»çµ± */
        .log-err { color: #fc8181; } /* ç´…è‰²ï¼šéŒ¯èª¤ */

        input[type="text"] { padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; width: 70%; font-family: monospace; }
        
        .control-group { margin-bottom: 15px; }
        .control-label { display: block; margin-bottom: 5px; font-weight: bold; color: #4a5568; }

        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <h1>ğŸ› ï¸ Micro:bit è—ç‰™è®€å¯«æ¸¬è©¦</h1>
    
    <div class="card full-width" style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>ç‹€æ…‹ï¼š</strong>
                <span id="connectionStatus" class="status-badge status-disconnected">æœªé€£æ¥</span>
                <span id="deviceInfo" style="margin-left: 10px; color: #718096;"></span>
            </div>
            <button id="btnConnect" class="btn-connect" style="width: auto;">ğŸ“¡ é€£æ¥ Micro:bit</button>
        </div>
    </div>

    <div class="container">
        <!-- ç™¼é€å€åŸŸ -->
        <div class="card">
            <h2>ğŸ“¤ ç™¼é€æ•¸æ“š (Write)</h2>
            <div class="control-group">
                <label class="control-label">å¿«é€ŸæŒ‡ä»¤ (æ¨¡æ“¬æ¡æ‰‹)</label>
                <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                    <button class="btn-cmd" onclick="send('ON')">ç™¼é€ "ON"</button>
                    <button class="btn-cmd" onclick="send('OFF')">ç™¼é€ "OFF"</button>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label">æ¨¡æ“¬ç¡¬ä»¶æŒ‰éˆ• (å¦‚æœéœ€è¦)</label>
                <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                    <button class="btn-cmd" onclick="send('BTN_DOWN')">ç™¼é€ "BTN_DOWN"</button>
                    <button class="btn-cmd" onclick="send('BTN_UP')">ç™¼é€ "BTN_UP"</button>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label">è‡ªå®šç¾©ç™¼é€</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="customInput" placeholder="è¼¸å…¥å…§å®¹..." onkeydown="if(event.key==='Enter') sendCustom()">
                    <button class="btn-send" onclick="sendCustom()">ç™¼é€</button>
                </div>
            </div>
        </div>

        <!-- æ¥æ”¶å€åŸŸ -->
        <div class="card">
            <h2>ğŸ“¥ æ¥æ”¶æ•¸æ“š (Notify)</h2>
            <div style="margin-bottom: 10px;">
                <span style="font-size: 0.9rem; color: #718096;">æœ€æ–°æ”¶åˆ°çš„æ•¸æ“šï¼š</span>
                <div id="latestValue" style="font-size: 1.5rem; font-weight: bold; color: #2b6cb0; min-height: 1.8rem;">-</div>
            </div>
            <div style="font-size: 0.8rem; color: #718096;">
                æ¥æ”¶è¨ˆæ•¸: <span id="rxCount">0</span>
            </div>
        </div>
        
        <!-- æ—¥èªŒå€åŸŸ -->
        <div class="card full-width">
            <h2>ğŸ“œ é€šä¿¡æ—¥èªŒ</h2>
            <div id="log"></div>
            <button onclick="document.getElementById('log').innerHTML=''" style="margin-top: 10px; background: #718096; padding: 5px 10px; font-size: 0.8rem;">æ¸…ç©ºæ—¥èªŒ</button>
        </div>
    </div>

    <script>
        // é…ç½®
        const UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const TX_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // é€šå¸¸æ˜¯ Notify
        const RX_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // é€šå¸¸æ˜¯ Write

        // ç‹€æ…‹
        let bluetoothDevice = null;
        let rxCharacteristic = null; // ç”¨æ–¼å¯«å…¥
        let rxCount = 0;

        // UI å…ƒç´ 
        const btnConnect = document.getElementById('btnConnect');
        const statusBadge = document.getElementById('connectionStatus');
        const deviceInfo = document.getElementById('deviceInfo');
        const logDiv = document.getElementById('log');
        const latestValueDiv = document.getElementById('latestValue');
        const rxCountSpan = document.getElementById('rxCount');

        // æ—¥èªŒå‡½æ•¸
        function addLog(msg, type = 'sys') {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            div.innerHTML = `<span class="log-time">[${time}]</span><span class="log-${type}">${msg}</span>`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // é€£æ¥æŒ‰éˆ•äº‹ä»¶
        btnConnect.addEventListener('click', async () => {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
                return;
            }
            await connect();
        });

        async function connect() {
            try {
                addLog('æ­£åœ¨è«‹æ±‚è¨­å‚™...', 'sys');
                // 1. è«‹æ±‚è¨­å‚™
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'BBC micro:bit' }],
                    optionalServices: [UART_SERVICE_UUID]
                });

                // 2. ç¶å®šæ–·é–‹äº‹ä»¶
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
                deviceInfo.textContent = `(${bluetoothDevice.name})`;
                addLog(`å·²é¸æ“‡è¨­å‚™: ${bluetoothDevice.name}`, 'sys');

                // 3. é€£æ¥ GATT
                addLog('æ­£åœ¨é€£æ¥ GATT...', 'sys');
                const server = await bluetoothDevice.gatt.connect();
                
                // 4. ç²å–æœå‹™ (å¸¶è¶…æ™‚è™•ç†)
                addLog('æ­£åœ¨ç²å– UART æœå‹™...', 'sys');
                const getServicesPromise = server.getPrimaryServices();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Service_Discovery_Timeout')), 5000)
                );

                let services;
                try {
                    services = await Promise.race([getServicesPromise, timeoutPromise]);
                } catch (e) {
                    if (e.message === 'Service_Discovery_Timeout') {
                        throw new Error('æœå‹™ç™¼ç¾è¶…æ™‚ï¼è«‹åœ¨ Windows è—ç‰™è¨­ç½®ä¸­åˆªé™¤è¨­å‚™å¾Œé‡è©¦ã€‚');
                    }
                    throw e;
                }

                const service = services.find(s => s.uuid.toLowerCase() === UART_SERVICE_UUID);
                if (!service) throw new Error('æœªæ‰¾åˆ° UART æœå‹™');

                addLog('âœ… æ‰¾åˆ° UART æœå‹™', 'sys');

                // 5. æ™ºèƒ½éæ­·ç‰¹å¾µå€¼ (è§£æ±º UUID ä¸åŒ¹é…å•é¡Œ)
                addLog('æ­£åœ¨æƒææ‰€æœ‰ç‰¹å¾µå€¼...', 'sys');
                const characteristics = await service.getCharacteristics();
                
                if (characteristics.length === 0) {
                    throw new Error('æœå‹™ä¸­æ²’æœ‰ç‰¹å¾µå€¼');
                }

                let txChar = null; // ç¢ºä¿åœ¨å¤–éƒ¨è²æ˜
                characteristics.forEach(c => {
                    const props = [];
                    if (c.properties.read) props.push('Read');
                    if (c.properties.write) props.push('Write');
                    if (c.properties.writeWithoutResponse) props.push('WriteNoResp');
                    if (c.properties.notify) props.push('Notify');
                    if (c.properties.indicate) props.push('Indicate');
                    
                    addLog(`ç™¼ç¾ç‰¹å¾µå€¼: ${c.uuid.slice(4, 8)} (${props.join(', ')})`, 'sys');
                    
                    // è‡ªå‹•é¸æ“‡å¯«å…¥é€šé“
                    if ((c.properties.write || c.properties.writeWithoutResponse) && !rxCharacteristic) {
                        rxCharacteristic = c;
                        addLog(`âœ… è‡ªå‹•ç¶å®šå¯«å…¥é€šé“ (RX): ${c.uuid.slice(4, 8)}`, 'sys');
                    }
                    
                    // è‡ªå‹•é¸æ“‡é€šçŸ¥é€šé“ (å„ªå…ˆé¸æ“‡æ”¯æŒ Notify çš„)
                    // æ³¨æ„ï¼šæœ‰äº›ç‰¹å¾µå€¼åŒæ™‚æ”¯æŒ Write å’Œ Notifyï¼Œæˆ‘å€‘éœ€è¦å°å¿ƒå€åˆ†
                    // é€šå¸¸ TX æ˜¯ Notifyï¼ŒRX æ˜¯ Write
                    if (c.properties.notify && !txChar) {
                        txChar = c;
                        addLog(`âœ… è‡ªå‹•ç¶å®šé€šçŸ¥é€šé“ (TX): ${c.uuid.slice(4, 8)}`, 'sys');
                    }
                });

                if (!txChar) {
                     // å¦‚æœæ²’æœ‰é¡¯å¼çš„ Notifyï¼Œå˜—è©¦æ‰¾ Indicate
                     const indicateChar = characteristics.find(c => c.properties.indicate);
                     if (indicateChar) {
                         txChar = indicateChar;
                         addLog(`âš ï¸ ä½¿ç”¨ Indicate é€šé“: ${indicateChar.uuid.slice(4, 8)}`, 'sys');
                     }
                }

                if (!rxCharacteristic) {
                    addLog('âŒ è­¦å‘Š: æœªæ‰¾åˆ°å¯å¯«å…¥çš„ç‰¹å¾µå€¼', 'err');
                }

                if (txChar) {
                    addLog('æ­£åœ¨å•Ÿç”¨é€šçŸ¥...', 'sys');
                    await txChar.startNotifications();
                    txChar.addEventListener('characteristicvaluechanged', handleNotifications);
                    addLog('âœ… é€šçŸ¥å·²å•Ÿç”¨ï¼Œæº–å‚™æ¥æ”¶æ•¸æ“š', 'sys');
                } else {
                    throw new Error('æœªæ‰¾åˆ°æ”¯æŒ Notify/Indicate çš„ç‰¹å¾µå€¼ (Micro:bit è—ç‰™æœå‹™å¯èƒ½æœªæ­£ç¢ºåˆå§‹åŒ–)');
                }

                onConnected();

            } catch (error) {
                console.error(error);
                let msg = error.message || error.toString();
                addLog(`é€£æ¥å¤±æ•—: ${msg}`, 'err');
                
                if (msg.includes('GATT') || msg.includes('NetworkError') || msg.includes('Connection')) {
                     addLog('ğŸ’¡ å¸¸è¦‹è§£æ±ºæ–¹æ¡ˆï¼š', 'warn');
                     addLog('1. è½‰åˆ° Windows "è¨­ç½®" > "è—ç‰™å’Œå…¶ä»–è¨­å‚™"', 'sys');
                     addLog('2. æ‰¾åˆ° "BBC micro:bit" ä¸¦é»æ“Š "åˆªé™¤è¨­å‚™"', 'sys');
                     addLog('3. æŒ‰ä¸€ä¸‹ Micro:bit èƒŒé¢çš„ Reset éµ', 'sys');
                     addLog('4. åˆ·æ–°æœ¬é é¢é‡è©¦', 'sys');
                }
                
                statusBadge.className = 'status-badge status-disconnected';
                statusBadge.textContent = 'é€£æ¥å¤±æ•—';
            }
        }

        function onConnected() {
            statusBadge.className = 'status-badge status-connected';
            statusBadge.textContent = 'å·²é€£æ¥';
            btnConnect.textContent = 'âŒ æ–·é–‹é€£æ¥';
            btnConnect.style.background = '#e53e3e';
            
            // å•Ÿç”¨æ‰€æœ‰æŒ‰éˆ•
            document.querySelectorAll('button').forEach(b => b.disabled = false);
        }

        function onDisconnected() {
            statusBadge.className = 'status-badge status-disconnected';
            statusBadge.textContent = 'å·²æ–·é–‹';
            btnConnect.textContent = 'ğŸ“¡ é€£æ¥ Micro:bit';
            btnConnect.style.background = '#3182ce';
            deviceInfo.textContent = '';
            addLog('è¨­å‚™å·²æ–·é–‹é€£æ¥', 'sys');
            rxCharacteristic = null;
        }

        function handleNotifications(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const str = decoder.decode(value).trim();
            
            // æ›´æ–° UI
            latestValueDiv.textContent = str;
            latestValueDiv.style.animation = 'none';
            latestValueDiv.offsetHeight; /* trigger reflow */
            latestValueDiv.style.animation = 'pulse 0.5s'; // éœ€è¦å®šç¾© pulse å‹•ç•«ï¼Œé€™è£¡ç°¡åŒ–
            
            rxCount++;
            rxCountSpan.textContent = rxCount;
            
            addLog(`æ”¶åˆ°: "${str}"`, 'rx');
        }

        async function send(cmd) {
            if (!bluetoothDevice || !bluetoothDevice.gatt.connected) {
                addLog('æœªé€£æ¥è¨­å‚™', 'err');
                return;
            }
            if (!rxCharacteristic) {
                addLog('æœªæ‰¾åˆ°å¯«å…¥ç‰¹å¾µå€¼', 'err');
                return;
            }

            try {
                const encoder = new TextEncoder();
                // æ·»åŠ æ›è¡Œç¬¦ï¼Œå› ç‚º MakeCode é€šå¸¸ä½¿ç”¨æ›è¡Œç¬¦ä½œç‚ºåˆ†éš”
                const data = encoder.encode(cmd + '\n');
                await rxCharacteristic.writeValue(data);
                addLog(`ç™¼é€: "${cmd}"`, 'tx');
            } catch (error) {
                addLog(`ç™¼é€å¤±æ•—: ${error.message}`, 'err');
            }
        }

        function sendCustom() {
            const input = document.getElementById('customInput');
            const val = input.value.trim();
            if (val) {
                send(val);
                input.value = ''; // æ¸…ç©ºè¼¸å…¥
            }
        }

        // æ·»åŠ å¿ƒè·³/æ¢æ¸¬åŠŸèƒ½
        setInterval(async () => {
            if (bluetoothDevice && bluetoothDevice.gatt.connected && rxCharacteristic) {
                // é€™æ˜¯ç‚ºäº†ä¿æŒé€£æ¥æ´»èºï¼ŒæŸäº›è¨­å‚™å¦‚æœé•·æ™‚é–“ä¸é€šè¨Šæœƒæ–·é–‹
                // ä½†é€™è£¡æˆ‘å€‘ä¸ä¸»å‹•ç™¼é€ï¼Œä»¥å…å¹²æ“¾ç”¨æˆ¶æ¸¬è©¦
            }
        }, 5000);
    </script>
</body>
</html>